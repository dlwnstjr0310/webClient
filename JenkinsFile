pipeline {
  agent any
  stages {
    stage('build') {
      steps {
        sh './gradlew clean build -x test'
      }
    }

    stage('zip') {
      steps {
        sh 'mkdir -p deploy'
        sh 'cp build/libs/refactor-api.jar deploy/refactor-api.jar'
        sh 'cp Procfile deploy/Procfile'
        sh 'cp -r .ebextensions/* deploy/.ebextensions'
        sh 'cp -r .platform/* deploy/.platform'
        sh 'cd deploy && zip -r deploy.zip .'
      }
    }

    stage('deploy') {
      steps {
        sh 'aws elasticbeanstalk create-application-version --region ap-northeast-2 --application-name HRSV --version-label ${BUILD_TAG} --source-bundle S3Bucket="elasticbeanstalk-ap-northeast-2-025736223629",S3Key="deploy/deploy.zip"'
        sh 'aws elasticbeanstalk update-environment --region ap-northeast-2 --environment-name HRSV-env --version-label ${BUILD_TAG}'
      }
    }

  }
}